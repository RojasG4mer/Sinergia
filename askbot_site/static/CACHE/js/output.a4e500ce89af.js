var TagDetailBox=function(boxType){WrappedElement.call(this);this.boxType=boxType;this._is_blank=true;this._tags=[];this.wildcard=undefined;};inherits(TagDetailBox,WrappedElement);TagDetailBox.prototype.createDom=function(){this._element=this.makeElement('div');this._element.addClass('wildcard-tags');this._headline=this.makeElement('p');this._headline.html(gettext('Tag "<span></span>" matches:'));this._element.append(this._headline);this._tag_list_element=this.makeElement('ul');this._tag_list_element.addClass('tags');this._element.append(this._tag_list_element);this._footer=this.makeElement('p');this._footer.css('clear','left');this._element.append(this._footer);this._element.hide();};TagDetailBox.prototype.belongsTo=function(wildcard){return(this.wildcard===wildcard);};TagDetailBox.prototype.isBlank=function(){return this._is_blank;};TagDetailBox.prototype.clear=function(){if(this.isBlank()){return;}
this._is_blank=true;this.getElement().hide();this.wildcard=null;$.each(this._tags,function(idx,item){item.dispose();});this._tags=[];this._tag_list_element.empty();};TagDetailBox.prototype.addTag=function(tag){this._tags.push(tag);var li=this.makeElement('li');li.append(tag.getElement());this._tag_list_element.append(li);this._tag_list_element.addClass('js-has-tags');};TagDetailBox.prototype.loadTags=function(wildcard,callback){var me=this;$.ajax({type:'GET',dataType:'json',cache:false,url:askbot.urls.get_tags_by_wildcard,data:{wildcard:wildcard},success:callback,failure:function(){me._loading=false;}});};TagDetailBox.prototype.renderFor=function(wildcard){var me=this;if(this._loading===true){return;}
this._loading=true;this.loadTags(wildcard,function(data,text_status,xhr){me._tag_names=data.tag_names;if(data.tag_count>0){var wildcard_display=wildcard.replace(/\*$/,'&#10045;');me._headline.find('span').html(wildcard_display);$.each(me._tag_names,function(idx,name){var tag=new Tag();tag.setName(name);tag.setUrlParams(name);me.addTag(tag);});me._is_blank=false;me.wildcard=wildcard;var tag_count=data.tag_count;if(tag_count>20){var fmts=gettext('and %s more, not shown...');var footer_text=interpolate(fmts,[tag_count-20]);me._footer.html(footer_text);me._footer.show();}else{me._footer.hide();}
me._element.show();}else{me.clear();}
me._loading=false;});};function pickedTags(){var interestingTags={};var ignoredTags={};var subscribedTags={};var interestingTagDetailBox=new TagDetailBox('interesting');var ignoredTagDetailBox=new TagDetailBox('ignored');var subscribedTagDetailBox=new TagDetailBox('subscribed');var sendAjax=function(tagnames,reason,action,callback){var url='';if(action==='add'){if(reason==='good'){url=askbot.urls.mark_interesting_tag;}else if(reason==='bad'){url=askbot.urls.mark_ignored_tag;}else{url=askbot.urls.mark_subscribed_tag;}}else{url=askbot.urls.unmark_tag;}
var data=JSON.stringify({tagnames:tagnames,reason:reason,user:askbot.data.viewUserId});var call_settings={type:'POST',url:url,data:data,dataType:'json'};if(callback!==false){call_settings.success=callback;}
$.ajax(call_settings);};var unpickTag=function(from_target,tagname,reason,send_ajax){var deleteTagLocally=function(){var tag=from_target[tagname];var li=tag.parent();var ul=li.parent();from_target[tagname].remove();if(li.prop('tagName')==='LI'){li.remove();}
if(ul.find('li').length===0){ul.removeClass('js-has-tags');}
delete from_target[tagname];};if(send_ajax){sendAjax([tagname],reason,'remove',function(reData){if(reData.success){deleteTagLocally();if($('body').hasClass('main-page')){askbot.controllers.fullTextSearch.refresh();}}else if(reData.message){var tag=from_target[tagname];showMessage(tag,reData.message,'after');}});}else{deleteTagLocally();}};var getTagList=function(reason){var base_selector='.js-marked-tags';var extra_selector='';if(reason==='good'){extra_selector='.js-interesting-tags';}else if(reason==='bad'){extra_selector='.js-ignored-tags';}else if(reason==='subscribed'){extra_selector='.subscribed';}
return $(base_selector+extra_selector);};var getWildcardTagDetailBox=function(reason){if(reason==='good'){return interestingTagDetailBox;}else if(reason==='bad'){return ignoredTagDetailBox;}else if(reason==='subscribed'){return subscribedTagDetailBox;}};var handleWildcardTagClick=function(tag_name,reason){var detail_box=getWildcardTagDetailBox(reason);var tag_box=getTagList(reason);if(detail_box.isBlank()){detail_box.renderFor(tag_name);}else if(detail_box.belongsTo(tag_name)){detail_box.clear();}else{detail_box.clear();detail_box.renderFor(tag_name);}
if(!detail_box.inDocument()){tag_box.after(detail_box.getElement());detail_box.enterDocument();}};var renderNewTags=function(clean_tag_names,reason,to_target,to_tag_container){$.each(clean_tag_names,function(idx,tag_name){var tag=new Tag();var delete_handler=function(){};tag.setName(tag_name);tag.setDeletable(true);if(/\*$/.test(tag_name)){tag.setLinkable(false);var detail_box=getWildcardTagDetailBox(reason);tag.setHandler(function(){handleWildcardTagClick(tag_name,reason);if(detail_box.belongsTo(tag_name)){detail_box.clear();}
return false;});delete_handler=function(){unpickTag(to_target,tag_name,reason,true);if(detail_box.belongsTo(tag_name)){detail_box.clear();}};}else{delete_handler=function(){unpickTag(to_target,tag_name,reason,true);};}
tag.setDeleteHandler(delete_handler);var tag_element=tag.getElement();var li=$('<li></li>');li.append(tag_element);to_tag_container.append(li);to_tag_container.addClass('js-has-tags');to_target[tag_name]=tag_element;});};var handlePickedTag=function(reason){var to_target=interestingTags;var from_target=ignoredTags;var to_tag_container;var input_sel='';if(reason==='bad'){input_sel='#js-ignored-tag-input';to_target=ignoredTags;from_target=interestingTags;to_tag_container=$('div .js-ignored-tags');}else if(reason==='good'){input_sel='#js-interesting-tag-input';to_tag_container=$('div .js-interesting-tags');}else if(reason==='subscribed'){input_sel='#js-subscribed-tag-input';to_target=subscribedTags;to_tag_container=$('div .js-subscribed-tags');}else{return;}
var tags_input=$.trim($(input_sel).val());if(tags_input===''){return;}
var tagnames=getUniqueWords(tags_input);if(reason!=='subscribed'){$.each(tagnames,function(idx,tagname){if(tagname in from_target){unpickTag(from_target,tagname,reason,false);}});}
var tagSettings=JSON.parse(askbot.settings.tag_editor);var clean_tagnames=[];$.each(tagnames,function(idx,tagname){if(!(tagname in to_target)){try{cleanTag(tagname,tagSettings);clean_tagnames.push(tagname);}catch(e){alert(e);}}});if(clean_tagnames.length>0){sendAjax(clean_tagnames,reason,'add',function(reData){if(reData.success){renderNewTags(clean_tagnames,reason,to_target,to_tag_container);$(input_sel).val('');askbot.controllers.fullTextSearch.refresh();}else if(reData.message){showMessage(to_tag_container,reData.message,'after');}});}};var collectPickedTags=function(section){var reason='';var tag_store;if(section==='js-interesting-tags'){reason='good';tag_store=interestingTags;}else if(section==='js-ignored-tags'){reason='bad';tag_store=ignoredTags;}else if(section==='js-subscribed-tags'){reason='subscribed';tag_store=subscribedTags;}else{return;}
$('.'+section+'.js-marked-tags .js-tag').each(function(i,item){var tag=new Tag();tag.decorate($(item));tag.setDeleteHandler(function(){unpickTag(tag_store,tag.getName(),reason,true);});if(tag.isWildcard()){tag.setHandler(function(){handleWildcardTagClick(tag.getName(),reason);return false;});}
tag_store[tag.getName()]=$(item);});};var setupTagFilterControl=function(control_type){var radioButtons=$('#js-'+control_type+'-tag-filter-control input');radioButtons.unbind('click');radioButtons.click(function(){var clickedBtn=$(this);$.ajax({type:'POST',dataType:'json',cache:false,url:askbot.urls.set_tag_filter_strategy,data:{filter_type:control_type,filter_value:clickedBtn.val()},success:function(){clickedBtn.prop('checked',true).trigger('change');askbot.controllers.fullTextSearch.refresh();}});return false;});};var getResultCallback=function(reason){return function(){handlePickedTag(reason);};};return{init:function(){collectPickedTags('js-interesting-tags');collectPickedTags('js-ignored-tags');collectPickedTags('js-subscribed-tags');setupTagFilterControl('display');setupTagFilterControl('email');var ac=new AutoCompleter({url:askbot.urls.get_tag_list,minChars:1,useCache:true,matchInside:true,maxCacheLength:100,delay:10});var interestingTagAc=$.extend(true,{},ac);interestingTagAc.decorate($('#js-interesting-tag-input'));interestingTagAc.setOption('onItemSelect',getResultCallback('good'));var ignoredTagAc=$.extend(true,{},ac);ignoredTagAc.decorate($('#js-ignored-tag-input'));ignoredTagAc.setOption('onItemSelect',getResultCallback('bad'));var subscribedTagAc=$.extend(true,{},ac);subscribedTagAc.decorate($('#js-subscribed-tag-input'));subscribedTagAc.setOption('onItemSelect',getResultCallback('subscribed'));$('#js-interesting-tag-add').click(getResultCallback('good'));$('#js-ignored-tag-add').click(getResultCallback('bad'));$('#js-subscribed-tag-add').click(getResultCallback('subscribed'));}};}
$(document).ready(function(){pickedTags().init();});;var SimpleControl=function(){WrappedElement.call(this);this._handler=null;this._title=null;};inherits(SimpleControl,WrappedElement);SimpleControl.prototype.setHandler=function(handler){this._handler=handler;if(this.hasElement()){this.setHandlerInternal();}};SimpleControl.prototype.getHandler=function(){return this._handler;};SimpleControl.prototype.setHandlerInternal=function(){setupButtonEventHandlers(this._element,this._handler);};SimpleControl.prototype.setTitle=function(title){this._title=title;};SimpleControl.prototype.decorate=function(element){this._element=element;this.setHandlerInternal();};;var Toggle=function(){this._state='off-state';this._messages={};this._states=['on-state','off-state','on-prompt','off-prompt'];};inherits(Toggle,SimpleControl);Toggle.prototype.resetStyles=function(){var element=this._element;var states=this._states;$.each(states,function(idx,state){element.removeClass(state);});this.setText('');};Toggle.prototype.isOn=function(){return this._element.data('isOn');};Toggle.prototype.isCheckBox=function(){var element=this._element;return element.attr('type')==='checkbox';};Toggle.prototype.setState=function(state){var element=this._element;var oldState=this._state;this._state=state;if(element){this.resetStyles();element.addClass(state);if(state==='on-state'){element.data('isOn',true);}else if(state==='off-state'){element.data('isOn',false);}
if(this.isCheckBox()){if(state==='on-state'){element.attr('checked',true);}else if(state==='off-state'){element.attr('checked',false);}}else{this.setText(this._messages[state]);}
this._element.trigger('askbot.Toggle.stateChange',{'oldState':oldState,'newState':state});}};Toggle.prototype.toggleState=function(){if(this.isOn()){this.setState('off-state');}else{this.setState('on-state');}};Toggle.prototype.setText=function(text){var btnText=this._element.find('.js-btn-text');var where=btnText.length?btnText:this._element;where.html(text);};Toggle.prototype.setMessages=function(messages){$.extend(this._messages,messages);};Toggle.prototype.setMessage=function(state,text){this._messages[state]=text;};Toggle.prototype.createDom=function(){var element=this.makeElement('div');this._element=element;var messages=this._messages||{};messages['on-state']=messages['on-state']||gettext('enabled');messages['off-state']=messages['off-state']||gettext('disabled');element.data('onStateText',messages['on-state']);element.data('offStateText',messages['off-state']);element.data('onPromptText',messages['on-prompt']||messages['off-state']);element.data('offPromptText',messages['off-prompt']||messages['on-state']);this.decorate(element);};Toggle.prototype.decorate=function(element){this._element=element;var messages={};messages['on-state']=element.data('onStateText')||gettext('enabled');messages['off-state']=element.data('offStateText')||gettext('disabled');messages['on-prompt']=element.data('onPromptText')||messages['off-state'];messages['off-prompt']=element.data('offPromptText')||messages['on-state'];this._messages=messages;if(this.isCheckBox()){this._state=element.is(':checked')?'on-state':'off-state';}else{this._state=element.data('isOn')?'on-state':this._state;}
this.setState(this._state);if(this.isCheckBox()===false){var me=this;element.mouseover(function(){var is_on=me.isOn();if(is_on){me.setState('off-prompt');}else{me.setState('on-prompt');}
return false;});element.mouseout(function(){var is_on=me.isOn();if(is_on){me.setState('on-state');}else{me.setState('off-state');}
return false;});}
setupButtonEventHandlers(element,this.getHandler());};;var AjaxToggle=function(){Toggle.call(this);this._handler=this.getDefaultHandler();this._postData={};this.toggleUrl='';this.setupDefaultDataValidators();};inherits(AjaxToggle,Toggle);AjaxToggle.prototype.setPostData=function(data){this._postData=data;};AjaxToggle.prototype.getPostData=function(){return this._postData;};AjaxToggle.prototype.setupDefaultDataValidators=function(){this._validators={'success':function(data){return data.success;},'enabled':function(data){return data.is_enabled;}}};AjaxToggle.prototype.setDataValidator=function(name,func){if(name==='success'||name==='enabled'){this._validators[name]=func;}else{throw'unknown validator name '+name;}};AjaxToggle.prototype.setBeforeSubmitHandler=function(func){this._beforeSubmitHandler=func;};AjaxToggle.prototype.getBeforeSubmitHandler=function(){return this._beforeSubmitHandler;};AjaxToggle.prototype.datumIsValid=function(validatorName,data){return this._validators[validatorName](data);};AjaxToggle.prototype.getDefaultHandler=function(){var me=this;return function(){var handler=me.getBeforeSubmitHandler();if(handler&&handler()===false){return;}
var data=me.getPostData();data.disable=me.isOn();$.ajax({type:'POST',dataType:'json',cache:false,url:me.toggleUrl,data:data,success:function(data){if(me.datumIsValid('success',data)){if(me.datumIsValid('enabled',data)){me.setState('on-state');}else{me.setState('off-state');}
me.getElement().trigger('askbot.two-state-toggle.success',data);}else{if(data.message){showMessage(me.getElement(),data.message);}
me.getElement().trigger('askbot.two-state-toggle.error',data);}}});};};AjaxToggle.prototype.decorate=function(element){this.toggleUrl=element.data('toggleUrl');getSuperClass(AjaxToggle).decorate.call(this,element);};;var GroupJoinButton=function(){AjaxToggle.call(this);};inherits(GroupJoinButton,AjaxToggle);GroupJoinButton.prototype.getPostData=function(){return{group_id:this._group_id};};GroupJoinButton.prototype.getHandler=function(){var me=this;return function(){$.ajax({type:'POST',dataType:'json',cache:false,data:me.getPostData(),url:askbot.urls.join_or_leave_group,success:function(data){if(data.success){var level=data.membership_level;var new_state='off-state';if(level==='full'||level==='pending'){new_state='on-state';}
me.setState(new_state);}else{showMessage(me.getElement(),data.message);}}});};};GroupJoinButton.prototype.decorate=function(elem){GroupJoinButton.superClass_.decorate.call(this,elem);this._group_id=this._element.data('groupId');};;